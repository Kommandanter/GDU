# By Yard1
# Why did I do this

# 0 1 2
# 3 4 5
# 6 7 8

# player:
# empty - 0
# human - 1
# AI - 2

TTT_set_up_tic_tac_toe = {
	set_variable = { winner = -1 }
	set_variable = { nextAIMove = -1 }
	set_temp_variable = { index = 0 }
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_0
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_1
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_2
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_3
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_4
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_5
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_6
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_7
		add_to_temp_variable = { index = 1 }
	}
	random_state = {
		limit = { NOT = { has_state_flag = TTT_field } }
		TTT_set_field = yes
		save_global_event_target_as = TTT_field_8
		add_to_temp_variable = { index = 1 }
	}
	#set_country_flag = TTT_is_being_played #for future multiplayer
	set_global_flag = TTT_in_progress
	if = {
		limit = { has_country_flag = TTT_AI_first }
		TTT_resolve = yes
	}
}

TTT_set_field = {
	set_state_flag = TTT_field
	set_variable = { field_index = index }
	set_variable = { player = 0 }
	set_variable = { tempPlayer = 0 }
}

TTT_resolve = {
	if = {
		limit = { TTT_has_player_won = yes }
		set_variable = { winner = 1 }
	}
	else_if = {
		limit = { TTT_has_AI_won = yes }
		set_variable = { winner = 2 }
	}
	else_if = {
		limit = { TTT_has_draw = yes }
		set_variable = { winner = 0 }
	}
	else = {
		random_list = {
			90 = { TTT_AI_move = yes } #smart
			10 = { TTT_AI_random_field = yes } #dumb
		}
		#print_variables = { file = log_file text = END append = yes }
		random_state = {
			limit = {
				has_state_flag = TTT_field
				check_variable = { field_index = ROOT.nextAIMove }
			}
			set_variable = { player = 2 }
		}
	}

	if = {
		limit = { TTT_has_AI_won = yes }
		set_variable = { winner = 2 }
	}
	else_if = {
		limit = { TTT_has_player_won = yes }
		set_variable = { winner = 1 }
	}
	else_if = {
		limit = { TTT_has_draw = yes }
		set_variable = { winner = 0 }
	}

	if = {
		limit = { check_variable = { winner > -1 } }
		set_global_flag = { flag = TTT_daily_refresh days = 1 value = 1 }
		if = {
			limit = { has_country_flag = TTT_AI_first }
			clr_country_flag = TTT_AI_first
			else = { set_country_flag = TTT_AI_first }
		}
		if = {
			limit = { check_variable = { winner = 0 } }
			event_target:TTT_score_counter = { add_to_variable = { TTT_draws = 1 } }
			break = yes
		}
		if = {
			limit = { check_variable = { winner = 1 } }
			event_target:TTT_score_counter = { add_to_variable = { TTT_wins = 1 } }
			break = yes
		}
		if = {
			limit = { check_variable = { winner = 2 } }
			event_target:TTT_score_counter = { add_to_variable = { TTT_loses = 1 } }
			break = yes
		}
	}
}

TTT_cleanup = {
	clear_variable = winner
	clear_variable = nextAIMove
	every_state = {
		limit = { has_state_flag = TTT_field }
		clr_state_flag = TTT_field
		clear_variable = field_index
		clear_variable = player
		clear_variable = tempPlayer
	}
	clear_global_event_target = TTT_field_0
	clear_global_event_target = TTT_field_1
	clear_global_event_target = TTT_field_2
	clear_global_event_target = TTT_field_3
	clear_global_event_target = TTT_field_4
	clear_global_event_target = TTT_field_5
	clear_global_event_target = TTT_field_6
	clear_global_event_target = TTT_field_7
	clear_global_event_target = TTT_field_8
	#clr_country_flag = TTT_is_being_played
	clr_global_flag = TTT_in_progress
}

TTT_AI_move = {
	set_variable = { nextAIMove = -1 }
	# check if AI can win in next move
	TTT_winning_move = yes
	#print_variables = { file = log_file text = WIN append = yes }

	# if not, block player
	if = {
		limit = { check_variable = { nextAIMove < 0 } }
		TTT_block_player = yes
	}
	#print_variables = { file = log_file text = BLOCK append = yes }

	# if not, try to take a corner
	if = {
		limit = { check_variable = { nextAIMove < 0 } }
		TTT_AI_random_corner = yes
	}
	#print_variables = { file = log_file text = CORNER append = yes }

	# if not, try to take the center
	if = {
		limit = {
			check_variable = { nextAIMove < 0 }
			event_target:TTT_field_4 = { check_variable = { player = 0 } }
		}
		set_variable = { nextAIMove = 4 }
	}
	#print_variables = { file = log_file text = CENTER append = yes }

	# if not, try to take a random side
	if = {
		limit = { check_variable = { nextAIMove < 0 } }
		TTT_AI_random_side = yes
	}
	#print_variables = { file = log_file text = SIDE append = yes }

	if = {
		limit = { check_variable = { nextAIMove < 0 } }
		TTT_AI_random_field = yes
	}

}

TTT_winning_move = {
	every_state = {
		limit = {
			has_state_flag = TTT_field
			check_variable = { player < 1 }
		}
		if = {
			limit = { check_variable = { ROOT.nextAIMove < 0 } }
			set_variable = { tempPlayer = 2 }
			ROOT = {
				if = {
					limit = { TTT_has_AI_won_temp = yes }
					set_variable = { nextAIMove = PREV.field_index }
				}
			}
			set_variable = { tempPlayer = player }
		}
	}
}

TTT_block_player = {
	every_state = {
		limit = {
			has_state_flag = TTT_field
			check_variable = { player < 1 }
		}
		if = {
			limit = { check_variable = { ROOT.nextAIMove < 0 } }
			set_variable = { tempPlayer = 1 }
			ROOT = {
				if = {
					limit = { TTT_has_player_won_temp = yes }
					set_variable = { nextAIMove = PREV.field_index }
				}
			}
			set_variable = { tempPlayer = player }
		}
	}
}

TTT_AI_random_corner = {
	random_list = {
		1 = {
			set_variable = { nextAIMove = 0 }
			modifier = {
				factor = 0
				event_target:TTT_field_0 = { check_variable = { player > 0 } }
			}
		}
		1 = {
			set_variable = { nextAIMove = 2 }
			modifier = {
				factor = 0
				event_target:TTT_field_2 = { check_variable = { player > 0 } }
			}
		}
		1 = {
			set_variable = { nextAIMove = 6 }
			modifier = {
				factor = 0
				event_target:TTT_field_6 = { check_variable = { player > 0 } }
			}
		}
		1 = {
			set_variable = { nextAIMove = 8 }
			modifier = {
				factor = 0
				event_target:TTT_field_8 = { check_variable = { player > 0 } }
			}
		}
		0 = {
			modifier = {
				add = 1000
				event_target:TTT_field_0 = { check_variable = { player > 0 } }
				event_target:TTT_field_2 = { check_variable = { player > 0 } }
				event_target:TTT_field_6 = { check_variable = { player > 0 } }
				event_target:TTT_field_8 = { check_variable = { player > 0 } }
			}
		}
	}
}

TTT_AI_random_side = {
	random_list = {
		1 = {
			set_variable = { nextAIMove = 1 }
			modifier = {
				factor = 0
				event_target:TTT_field_1 = { check_variable = { player > 0 } }
			}
		}
		1 = {
			set_variable = { nextAIMove = 3 }
			modifier = {
				factor = 0
				event_target:TTT_field_3 = { check_variable = { player > 0 } }
			}
		}
		1 = {
			set_variable = { nextAIMove = 5 }
			modifier = {
				factor = 0
				event_target:TTT_field_5 = { check_variable = { player > 0 } }
			}
		}
		1 = {
			set_variable = { nextAIMove = 7 }
			modifier = {
				factor = 0
				event_target:TTT_field_7 = { check_variable = { player > 0 } }
			}
		}
		0 = {
			modifier = {
				add = 1000
				event_target:TTT_field_1 = { check_variable = { player > 0 } }
				event_target:TTT_field_3 = { check_variable = { player > 0 } }
				event_target:TTT_field_5 = { check_variable = { player > 0 } }
				event_target:TTT_field_7 = { check_variable = { player > 0 } }
			}
		}
	}
}

TTT_AI_random_field = {
	random_list = {
		4 = {
			TTT_AI_random_corner = yes
			modifier = {
				factor = 0
				event_target:TTT_field_0 = { check_variable = { player > 0 } }
				event_target:TTT_field_2 = { check_variable = { player > 0 } }
				event_target:TTT_field_6 = { check_variable = { player > 0 } }
				event_target:TTT_field_8 = { check_variable = { player > 0 } }
			}
		}
		4 = {
			TTT_AI_random_side = yes
			modifier = {
				factor = 0
				event_target:TTT_field_1 = { check_variable = { player > 0 } }
				event_target:TTT_field_3 = { check_variable = { player > 0 } }
				event_target:TTT_field_5 = { check_variable = { player > 0 } }
				event_target:TTT_field_7 = { check_variable = { player > 0 } }
			}
		}
		1 = {
			#center
			set_variable = { nextAIMove = 4 }
			modifier = {
				factor = 0
				event_target:TTT_field_4 = { check_variable = { player > 0 } }
			}
		}
	}
}
